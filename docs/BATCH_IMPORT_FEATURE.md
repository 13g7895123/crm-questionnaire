# 批量匯入功能說明

## 功能概述

為會員中心的**供應商管理**和**部門管理**提供批量匯入功能，支援 Excel 檔案批量新增資料。

## 功能特色

### ✅ 範本下載
- 提供 Excel 範本檔案下載
- 範本包含完整的欄位說明和範例資料
- 使用說明書單獨放在「使用說明」工作表

### ✅ 資料驗證
- 欄位必填檢查
- 資料格式驗證
- 下拉選單限制輸入錯誤

### ✅ 防重複機制
- **組織/供應商**：名稱不可重複
- **部門**：同一組織內的部門名稱不可重複（不同組織可以有相同名稱的部門）

### ✅ 錯誤處理
- 逐行驗證資料
- 詳細的錯誤訊息（標示錯誤行號和原因）
- 重複資料自動跳過
- 部分成功匯入（不會因為部分錯誤而全部失敗）

## 使用流程

### 1. 供應商/組織批量匯入

#### 步驟：
1. 進入「會員中心」→「供應商管理」
2. 點擊「下載範本」按鈕
3. 填寫 Excel 範本：
   - **組織名稱**：必填，不可重複
   - **類型**：必選，HOST（主機構）或 SUPPLIER（供應商）
   - **備註**：選填，僅供參考
4. 點擊「匯入」按鈕
5. 選擇填好的 Excel 檔案
6. 點擊「上傳」
7. 查看匯入結果

#### 範本格式：

| 組織名稱 | 類型 (HOST/SUPPLIER) | 備註 |
|---------|---------------------|------|
| 範例供應商 A | SUPPLIER | 這是範例，可以刪除 |
| 範例供應商 B | SUPPLIER |  |
| 範例主機構 C | HOST |  |

#### 驗證規則：
- ✅ 組織名稱必填，最多 200 字元
- ✅ 類型必須是 HOST 或 SUPPLIER
- ❌ 名稱重複會被跳過
- ⚠️ 最多一次匯入 1000 筆

---

### 2. 部門批量匯入

#### 步驟：
1. 進入「會員中心」→「部門管理」
2. 點擊「下載範本」按鈕
3. 填寫 Excel 範本：
   - **部門名稱**：必填
   - **組織名稱**：必選（從下拉選單選擇現有組織）
   - **備註**：選填，僅供參考
4. 點擊「匯入」按鈕
5. 選擇填好的 Excel 檔案
6. 點擊「上傳」
7. 查看匯入結果

#### 範本格式：

| 部門名稱 | 組織名稱 | 備註 |
|---------|---------|------|
| 品質管理部 | 範例組織 | 這是範例，可以刪除 |
| 採購部 | 範例組織 |  |
| 研發部 | 範例組織 |  |

#### 驗證規則：
- ✅ 部門名稱必填，最多 100 字元
- ✅ 組織名稱必須是系統中已存在的組織
- ✅ 範本會自動產生現有組織的下拉選單
- ❌ 同一組織內名稱重複會被跳過
- ✅ 不同組織可以有相同名稱的部門
- ⚠️ 最多一次匯入 1000 筆

---

## API 端點

### 組織/供應商

#### 下載範本
```
GET /api/v1/organizations/import-template
Authorization: Bearer <token>
```

#### 匯入資料
```
POST /api/v1/organizations/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

Body:
  file: <excel_file>
```

**回應格式：**
```json
{
  "success": 10,
  "skipped": 2,
  "total": 12,
  "message": "成功匯入 10 筆，跳過 2 筆",
  "errors": [
    "第 3 行：組織名稱 'ABC公司' 已存在，已跳過",
    "第 7 行：類型必須為 HOST 或 SUPPLIER"
  ]
}
```

### 部門

#### 下載範本
```
GET /api/v1/departments/import-template
Authorization: Bearer <token>
```

#### 匯入資料
```
POST /api/v1/departments/import
Authorization: Bearer <token>
Content-Type: multipart/form-data

Body:
  file: <excel_file>
```

**回應格式：**
```json
{
  "success": 8,
  "skipped": 1,
  "total": 9,
  "message": "成功匯入 8 筆，跳過 1 筆",
  "errors": [
    "第 5 行：組織 '測試公司' 已存在部門 '品質部'，已跳過"
  ]
}
```

---

## 防重複機制

### 組織/供應商
- **檢查欄位**：組織名稱
- **檢查範圍**：全域（所有組織）
- **處理方式**：重複記錄自動跳過，不影響其他資料匯入

### 部門
- **檢查欄位**：部門名稱 + 組織 ID
- **檢查範圍**：同一組織內
- **處理方式**：同組織內重複記錄自動跳過
- **特別說明**：不同組織可以有相同名稱的部門

### 實例說明

#### ✅ 允許的情況：
```
組織A - 品質管理部
組織B - 品質管理部  ← 允許（不同組織）
```

#### ❌ 不允許的情況：
```
組織A - 品質管理部
組織A - 品質管理部  ← 不允許（同組織重複）
```

---

## 錯誤處理

### 常見錯誤及解決方法

| 錯誤訊息 | 原因 | 解決方法 |
|---------|------|---------|
| 組織名稱不可為空 | 必填欄位未填寫 | 填寫組織名稱 |
| 類型必須為 HOST 或 SUPPLIER | 類型欄位填寫錯誤 | 從下拉選單選擇正確的類型 |
| 組織名稱 'XXX' 已存在 | 資料庫中已有相同名稱 | 修改為不同的名稱或跳過 |
| 找不到組織 'XXX' | 組織名稱不存在於系統 | 確認組織名稱正確，或先建立該組織 |
| 只允許上傳 .xlsx 或 .xls 格式 | 檔案格式錯誤 | 使用正確的 Excel 格式 |
| 一次最多只能匯入 1000 筆 | 資料筆數超過限制 | 分批匯入 |

---

## 技術實現

### 後端實現

#### 組織控制器
- **檔案**：`backend/app/Controllers/Api/V1/OrganizationController.php`
- **方法**：
  - `downloadImportTemplate()` - 產生 Excel 範本
  - `import()` - 處理檔案上傳和資料匯入

#### 部門控制器
- **檔案**：`backend/app/Controllers/Api/V1/DepartmentController.php`
- **方法**：
  - `downloadImportTemplate()` - 產生 Excel 範本（包含組織下拉選單）
  - `import()` - 處理檔案上傳和資料匯入

#### 資料驗證
- 使用 `PhpOffice\PhpSpreadsheet` 處理 Excel
- 資料庫事務確保資料一致性
- Model 層級的重複檢查

### 前端實現

#### 供應商頁面
- **檔案**：`frontend/app/pages/account/suppliers/index.vue`
- **功能**：
  - 下載範本按鈕
  - 匯入按鈕和 Modal
  - 檔案上傳和結果顯示

#### 部門頁面
- **檔案**：`frontend/app/pages/account/departments/index.vue`
- **功能**：
  - 下載範本按鈕
  - 匯入按鈕和 Modal
  - 檔案上傳和結果顯示

---

## 測試建議

### 功能測試

1. **正常流程測試**
   - 下載範本
   - 填寫有效資料
   - 成功匯入
   - 驗證資料正確性

2. **防重複測試**
   - 匯入重複的組織名稱
   - 匯入同組織內重複的部門名稱
   - 驗證重複資料被正確跳過

3. **錯誤處理測試**
   - 空白必填欄位
   - 錯誤的類型值
   - 不存在的組織名稱（部門匯入）
   - 超過 1000 筆資料
   - 錯誤的檔案格式

4. **邊界測試**
   - 最大長度的名稱
   - 特殊字符
   - 完全空白的檔案

### 測試資料範例

#### 組織匯入測試資料
```
測試供應商A, SUPPLIER
測試供應商B, SUPPLIER  
測試主機構, HOST
重複供應商A, SUPPLIER  (測試重複)
, SUPPLIER             (測試空白)
測試供應商C, INVALID   (測試無效類型)
```

#### 部門匯入測試資料
```
品質部, 測試供應商A
採購部, 測試供應商A
品質部, 測試供應商A     (測試同組織重複)
品質部, 測試供應商B     (測試不同組織相同名稱)
研發部, 不存在的組織    (測試無效組織)
, 測試供應商A           (測試空白)
```

---

## 未來改進建議

1. **範本自訂**
   - 允許管理員自訂範本欄位
   - 支援更多資料欄位

2. **批量編輯**
   - 支援匯入時更新現有資料
   - 提供「新增或更新」模式

3. **匯入歷史**
   - 記錄匯入操作
   - 提供匯入歷史查詢
   - 支援匯入回滾

4. **進階驗證**
   - 跨欄位驗證
   - 自訂驗證規則
   - 外部資料源驗證

5. **效能優化**
   - 大量資料非同步處理
   - 進度條顯示
   - 背景任務處理

---

## 權限控制

- ✅ 僅 **ADMIN** 角色可以使用批量匯入功能
- ✅ 下載範本也需要 ADMIN 權限
- ✅ 所有操作都需要 JWT 認證

---

## 相關文件

- [API 規格書](./API-SPECIFICATION.md)
- [生產環境部署指南](./PRODUCTION_DEPLOYMENT_GUIDE.md)
- [前端開發總結](./FRONTEND_DEVELOPMENT_SUMMARY.md)
